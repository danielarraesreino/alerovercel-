{% extends "base.html" %}

{% block title %}AleroPrice - Relatório de Lucratividade por Prato{% endblock %}

{% block extra_css %}
<style>
    .card-dashboard {
        transition: transform 0.3s;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-dashboard:hover {
        transform: translateY(-5px);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }

    .dashboard-subtitle {
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #495057;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .bg-high-margin {
        background-color: #d4edda;
    }

    .bg-medium-margin {
        background-color: #fff3cd;
    }

    .bg-low-margin {
        background-color: #f8d7da;
    }

    .text-profit {
        color: #28a745;
    }

    .text-loss {
        color: #dc3545;
    }

    .metric-card {
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        margin-bottom: 15px;
    }

    .metric-card .value {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .metric-card .title {
        font-size: 1rem;
        color: #6c757d;
    }

    .revenue-card {
        background-color: #cce5ff;
        border: 1px solid #b8daff;
    }

    .cost-card {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
    }

    .profit-card {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
    }

    .margin-card {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
    }

    .filter-form {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    .categoria-header {
        background-color: #f8f9fa;
        padding: 10px;
        margin-top: 20px;
        margin-bottom: 10px;
        border-radius: 5px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col-md-8">
        <h1 class="mb-0">Relatório de Lucratividade por Prato</h1>
        <p class="text-muted">{{ data_inicio }} a {{ data_fim }}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>
</div>

<!-- Filtro de período -->
<div class="row mb-4">
    <div class="col-12">
        <div class="filter-form">
            <form method="get" action="" class="d-flex align-items-end">
                <div class="me-3">
                    <label for="data_inicio" class="form-label me-2">De:</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                        value="{{ data_inicio }}">
                </div>
                <div class="me-3">
                    <label for="data_fim" class="form-label me-2">Até:</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim }}">
                </div>
                <button type="submit" class="btn btn-primary">Filtrar</button>
            </form>
        </div>
    </div>
</div>

<!-- Métricas resumidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card revenue-card">
            <div class="title">Receita Total</div>
            <div class="value">R$ {{ "%.2f"|format(total_receita) }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card cost-card">
            <div class="title">Custo Total</div>
            <div class="value">R$ {{ "%.2f"|format(total_custo) }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card profit-card">
            <div class="title">Lucro Total</div>
            <div class="value">R$ {{ "%.2f"|format(total_lucro) }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card margin-card">
            <div class="title">Margem Média</div>
            <div class="value">{{ "%.1f"|format(margem_media) }}%</div>
        </div>
    </div>
</div>

<!-- Tabela de pratos por categoria -->
<div class="row">
    <div class="col-12">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Análise de Lucratividade por Categoria</h5>

                {% for categoria, dados in categorias %}
                <div class="categoria-header">
                    <div class="row">
                        <div class="col-md-6">{{ categoria }}</div>
                        <div class="col-md-2 text-end">Receita: R$ {{ "%.2f"|format(dados.receita) }}</div>
                        <div class="col-md-2 text-end">Lucro: R$ {{ "%.2f"|format(dados.lucro) }}</div>
                        <div class="col-md-2 text-end">Margem: {{ "%.1f"|format(dados.margem) }}%</div>
                    </div>
                </div>

                <div class="table-responsive mb-4">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Nome do Prato</th>
                                <th class="text-end">Quant.</th>
                                <th class="text-end">Preço Venda</th>
                                <th class="text-end">Receita</th>
                                <th class="text-end">Custo Direto</th>
                                <th class="text-end">Custo Indireto</th>
                                <th class="text-end">Custo Total</th>
                                <th class="text-end">Lucro</th>
                                <th class="text-end">Margem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prato in dados.pratos %}
                            <tr
                                class="{% if prato.margem >= 30 %}bg-high-margin{% elif prato.margem >= 15 %}bg-medium-margin{% elif prato.margem < 0 %}bg-low-margin{% endif %}">
                                <td>{{ prato.nome }}</td>
                                <td class="text-end">{{ prato.quantidade_vendida }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.preco_venda) }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.receita_total) }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.custo_direto_total) }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.custo_indireto_estimado) }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.custo_total) }}</td>
                                <td class="text-end {% if prato.lucro > 0 %}text-profit{% else %}text-loss{% endif %}">
                                    R$ {{ "%.2f"|format(prato.lucro) }}</td>
                                <td class="text-end">{{ "%.1f"|format(prato.margem) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Tabela completa de pratos -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Todos os Pratos (Ordenados por Margem)</h5>
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Nome do Prato</th>
                                <th>Categoria</th>
                                <th class="text-end">Quant.</th>
                                <th class="text-end">Preço Venda</th>
                                <th class="text-end">Receita</th>
                                <th class="text-end">Custo Total</th>
                                <th class="text-end">Lucro</th>
                                <th class="text-end">Margem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prato in pratos %}
                            <tr
                                class="{% if prato.margem >= 30 %}bg-high-margin{% elif prato.margem >= 15 %}bg-medium-margin{% elif prato.margem < 0 %}bg-low-margin{% endif %}">
                                <td>{{ prato.nome }}</td>
                                <td>{{ prato.categoria or 'Sem Categoria' }}</td>
                                <td class="text-end">{{ prato.quantidade_vendida }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.preco_venda) }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.receita_total) }}</td>
                                <td class="text-end">R$ {{ "%.2f"|format(prato.custo_total) }}</td>
                                <td class="text-end {% if prato.lucro > 0 %}text-profit{% else %}text-loss{% endif %}">
                                    R$ {{ "%.2f"|format(prato.lucro) }}</td>
                                <td class="text-end">{{ "%.1f"|format(prato.margem) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recomendações -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card card-dashboard">
            <div class="card-body">
                <h5 class="card-title">Recomendações</h5>
                <ul class="list-group">
                    <li class="list-group-item list-group-item-success">
                        <strong>Produtos com Alta Margem:</strong> Promova mais os pratos com margem acima de 30% para
                        maximizar lucros.
                    </li>
                    <li class="list-group-item list-group-item-warning">
                        <strong>Produtos com Margem Média:</strong> Avalie oportunidades para reduzir custos ou aumentar
                        preços em pratos com margem entre 15% e 30%.
                    </li>
                    <li class="list-group-item list-group-item-danger">
                        <strong>Produtos com Baixa Margem:</strong> Considere reformular ou substituir produtos com
                        margem abaixo de 15%, especialmente os com margem negativa.
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}