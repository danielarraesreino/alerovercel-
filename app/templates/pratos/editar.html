{% extends "base.html" %}

{% block title %}Editar Prato{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Editar Prato</h1>
        <a href="{{ url_for('pratos.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados do Prato</h6>
        </div>
        <div class="card-body">
            <form method="POST" id="formPrato">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome
                                <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Nome do Prato" data-content="Digite o nome completo do prato. Ex: Filé ao Molho Madeira">
                                    <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                                </span>
                            </label>
                            <input type="text" class="form-control" id="nome" name="nome" value="{{ prato.nome }}" required>
                            <small class="form-text text-muted">Ex: Filé ao Molho Madeira, Risoto de Cogumelos, etc.</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="categoria" class="form-label">Categoria
                                <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Categoria do Prato" data-content="Selecione a categoria que melhor representa este prato no seu cardápio">
                                    <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                                </span>
                            </label>
                            <select class="form-control" id="categoria" name="categoria">
                                <option value="">Selecione...</option>
                                <option value="entrada" {% if prato.categoria == 'entrada' %}selected{% endif %}>Entrada</option>
                                <option value="prato_principal" {% if prato.categoria == 'prato_principal' %}selected{% endif %}>Prato Principal</option>
                                <option value="sobremesa" {% if prato.categoria == 'sobremesa' %}selected{% endif %}>Sobremesa</option>
                                <option value="bebida" {% if prato.categoria == 'bebida' %}selected{% endif %}>Bebida</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="descricao" class="form-label">Descrição
                        <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Descrição do Prato" data-content="Descreva os principais ingredientes e características do prato">
                            <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                        </span>
                    </label>
                    <textarea class="form-control" id="descricao" name="descricao" rows="3">{{ prato.descricao }}</textarea>
                    <small class="form-text text-muted">Ex: Filé mignon grelhado ao molho madeira, acompanhado de arroz e legumes</small>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="rendimento" class="form-label">Rendimento Total
                                <span tabindex="0" data-toggle="popover" data-trigger="focus" title="O que é Rendimento?" data-content="Informe a quantidade total que a receita irá produzir. Exemplo: se a receita rende 15kg, coloque 15. Se for 20 porções, coloque 20 e selecione a unidade correspondente.">
                                    <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="rendimento" name="rendimento" step="0.01" value="{{ prato.rendimento }}" required>
                            <small class="form-text text-muted">Ex: 15 para 15kg, 20 para 20 porções</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="unidade_rendimento" class="form-label">Unidade
                                <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Unidade de Medida" data-content="Selecione a unidade de medida do rendimento. Use 'un' para porções">
                                    <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                                </span>
                            </label>
                            <select class="form-control" id="unidade_rendimento" name="unidade_rendimento" required>
                                <option value="">Selecione...</option>
                                <option value="kg" {% if prato.unidade_rendimento == 'kg' %}selected{% endif %}>Quilograma (kg)</option>
                                <option value="g" {% if prato.unidade_rendimento == 'g' %}selected{% endif %}>Grama (g)</option>
                                <option value="l" {% if prato.unidade_rendimento == 'l' %}selected{% endif %}>Litro (L)</option>
                                <option value="ml" {% if prato.unidade_rendimento == 'ml' %}selected{% endif %}>Mililitro (ml)</option>
                                <option value="un" {% if prato.unidade_rendimento == 'un' %}selected{% endif %}>Unidade (un)</option>
                            </select>
                            <small class="form-text text-muted">Selecione a unidade de medida do rendimento</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="porcoes_rendimento" class="form-label">Porções por Rendimento
                                <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Porções" data-content="Quantas porções este rendimento produz? Ex: se 15kg rende 30 porções, coloque 30">
                                    <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="porcoes_rendimento" name="porcoes_rendimento" value="{{ prato.porcoes_rendimento }}" required>
                            <small class="form-text text-muted">Ex: 30 porções para 15kg</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="tempo_preparo" class="form-label">Tempo de Preparo (min)
                                <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Tempo de Preparo" data-content="Tempo estimado para preparar o prato, em minutos">
                                    <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                                </span>
                            </label>
                            <input type="number" class="form-control" id="tempo_preparo" name="tempo_preparo" value="{{ prato.tempo_preparo }}">
                            <small class="form-text text-muted">Ex: 45 para 45 minutos</small>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="margem" class="form-label">Margem de Lucro (%)
                        <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Margem de Lucro" data-content="Percentual de lucro desejado sobre o custo total do prato">
                            <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                        </span>
                    </label>
                    <input type="number" class="form-control" id="margem" name="margem" value="{{ prato.margem }}" step="0.01">
                    <small class="form-text text-muted">Ex: 30 para 30% de margem de lucro</small>
                </div>
                <div class="mb-3">
                    <label for="ingrediente" class="form-label">Ingredientes
                        <span tabindex="0" data-toggle="popover" data-trigger="focus" title="Ingredientes" data-content="Digite o nome do ingrediente e selecione da lista de sugestões. Você pode adicionar vários ingredientes">
                            <i class="fas fa-question-circle text-info" style="cursor:pointer;"></i>
                        </span>
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="ingrediente" placeholder="Digite o nome do ingrediente...">
                        <button type="button" class="btn btn-primary" id="btnAdicionarIngrediente">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <small class="form-text text-muted">Digite o nome do ingrediente e selecione da lista de sugestões</small>
                    <ul id="sugestoes" class="list-group mt-2"></ul>
                </div>
                <div class="mb-3">
                    <h6>Ingredientes Adicionados</h6>
                    <div id="listaIngredientes" class="list-group">
                        {% for insumo in prato.insumos %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ insumo.produto.nome }}</strong>
                                <input type="number" class="form-control form-control-sm d-inline-block w-25 ms-2" 
                                       name="quantidade_{{ insumo.produto.id }}" value="{{ insumo.quantidade }}" placeholder="Qtd" required>
                                <input type="hidden" name="ingredientes[]" value="{{ insumo.produto.id }}">
                            </div>
                            <button type="button" class="btn btn-sm btn-danger remover-ingrediente" data-index="{{ loop.index0 }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Resumo da Ficha Técnica</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Ingredientes</h6>
                                <div id="resumoIngredientes">
                                    <p class="text-muted">Nenhum ingrediente adicionado</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Impacto no Estoque</h6>
                                <div id="impactoEstoque">
                                    <p class="text-muted">Adicione ingredientes para ver o impacto no estoque</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar ingredientes já existentes
    const _ids = JSON.parse("{{ (prato.insumos | map(attribute='produto') | map(attribute='id') | list | default([])) | tojson | safe }}");
    const _nomes = JSON.parse("{{ (prato.insumos | map(attribute='produto') | map(attribute='nome') | list | default([])) | tojson | safe }}");
    let ingredientesAdicionados = [];
    for (let i = 0; i < _ids.length; i++) {
        ingredientesAdicionados.push({ id: _ids[i], nome: _nomes[i] });
    }
    let resumoIngredientes = {};

    $('[data-toggle="popover"]').popover();

    function atualizarResumoIngredientes() {
        resumoIngredientes = {};
        ingredientesAdicionados.forEach(function(ingrediente) {
            const quantidade = $(`input[name='quantidade_${ingrediente.id}']`).val();
            if (quantidade) {
                resumoIngredientes[ingrediente.id] = {
                    nome: ingrediente.nome,
                    quantidade: quantidade
                };
            }
        });
        const resumoHtml = Object.values(resumoIngredientes)
            .map(ing => `<li>${ing.nome}: ${ing.quantidade}</li>`)
            .join('');
        if (resumoHtml) {
            $('#resumoIngredientes').html(`<ul>${resumoHtml}</ul>`);
            verificarEstoque();
        } else {
            $('#resumoIngredientes').html('<p class="text-muted">Nenhum ingrediente adicionado</p>');
            $('#impactoEstoque').html('<p class="text-muted">Adicione ingredientes para ver o impacto no estoque</p>');
        }
    }

    $('#ingrediente').on('input', function() {
        const termo = $(this).val();
        if (termo.length > 2) {
            $.get('/pratos/api/sugerir_ingredientes', { termo: termo }, function(data) {
                const sugestoes = $('#sugestoes');
                sugestoes.empty();
                data.forEach(function(ingrediente) {
                    sugestoes.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${ingrediente.nome}
                            <button type="button" class="btn btn-sm btn-primary adicionar-ingrediente" 
                                    data-id="${ingrediente.id}" 
                                    data-nome="${ingrediente.nome}">
                                Adicionar
                            </button>
                        </li>
                    `);
                });
            });
        } else {
            $('#sugestoes').empty();
        }
    });

    $(document).on('click', '.adicionar-ingrediente', function() {
        const id = $(this).data('id');
        const nome = $(this).data('nome');
        if (!ingredientesAdicionados.find(i => i.id == id)) {
            ingredientesAdicionados.push({ id, nome });
            atualizarListaIngredientes();
            atualizarResumoIngredientes();
        }
        $('#ingrediente').val('');
        $('#sugestoes').empty();
    });

    function atualizarListaIngredientes() {
        const lista = $('#listaIngredientes');
        lista.empty();
        ingredientesAdicionados.forEach(function(ingrediente, index) {
            lista.append(`
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${ingrediente.nome}</strong>
                        <input type="number" class="form-control form-control-sm d-inline-block w-25 ms-2" 
                               name="quantidade_${ingrediente.id}" placeholder="Qtd" required
                               onchange="atualizarResumoIngredientes()">
                        <input type="hidden" name="ingredientes[]" value="${ingrediente.id}">
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remover-ingrediente" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `);
        });
    }

    $(document).on('click', '.remover-ingrediente', function() {
        const index = $(this).data('index');
        ingredientesAdicionados.splice(index, 1);
        atualizarListaIngredientes();
        atualizarResumoIngredientes();
    });

    $('#formPrato').on('submit', function(e) {
        e.preventDefault();
        if (ingredientesAdicionados.length === 0) {
            alert('Adicione pelo menos um ingrediente!');
            return;
        }
        let todosTemQuantidade = true;
        ingredientesAdicionados.forEach(function(ingrediente) {
            const quantidade = $(`input[name='quantidade_${ingrediente.id}']`).val();
            if (!quantidade || quantidade <= 0) {
                todosTemQuantidade = false;
            }
        });
        if (!todosTemQuantidade) {
            alert('Todos os ingredientes devem ter uma quantidade válida!');
            return;
        }
        this.submit();
    });

    atualizarListaIngredientes();
    atualizarResumoIngredientes();

    function verificarEstoque() {
        const ingredientesIds = Object.keys(resumoIngredientes);
        if (ingredientesIds.length === 0) return;
        $.get('/pratos/api/verificar_estoque', { 
            ingredientes: ingredientesIds,
            quantidades: Object.values(resumoIngredientes).map(i => i.quantidade)
        }, function(data) {
            let html = '<ul>';
            let temFalta = false;
            data.forEach(function(item) {
                const status = item.estoque_suficiente ? 
                    '<span class="text-success"><i class="fas fa-check-circle"></i> Suficiente</span>' : 
                    '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> Insuficiente</span>';
                if (!item.estoque_suficiente) temFalta = true;
                html += `
                    <li>
                        ${item.nome}: ${item.quantidade_necessaria} ${item.unidade}
                        <br>
                        <small>Estoque atual: ${item.estoque_atual} ${item.unidade} - ${status}</small>
                    </li>
                `;
            });
            html += '</ul>';
            if (temFalta) {
                html += `
                    <div class="alert alert-warning mt-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        Atenção: Alguns ingredientes têm estoque insuficiente!
                    </div>
                `;
            }
            $('#impactoEstoque').html(html);
        });
    }
});
</script>
{% endblock %} 